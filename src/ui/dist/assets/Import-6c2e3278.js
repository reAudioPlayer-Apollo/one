import{i as M,B as F,u as P,o as d,c as y,g as w,h as z,a as r,M as H,bU as K,t as k,F as B,j as I,I as N,d as h,_ as G,f as $,w as q,b as j,C as D,q as S,k as U,E as X,O as Q,m as R,n as Y,L as Z,x as ee,X as te,N as se,c8 as ae,c9 as le,ca as ne}from"./index-3242661c.js";import{G as V}from"./gistClient-fb99461e.js";import{I as oe}from"./IconButton-7653a4c9.js";import{a as ie}from"./collection-74d0fd18.js";const de=(e,c)=>{const t={source:e.source,id:e.id,changed:{}},l=t.changed,i=["id","href","duration","plays","artists"];for(const n of Object.keys(e))if(!i.includes(n)){if(n==="metadata"){const f=e.metadata,a=c.metadata;if(f&&a){if(!f.spotify&&!a.spotify)continue;if(!f.spotify&&a.spotify){l.metadata={from:f,to:a};continue}if(f.spotify&&!a.spotify){l.metadata={from:f,to:a};continue}f.spotify.id!==a.spotify.id&&(l.metadata={from:f,to:a})}else(f||a)&&(l.metadata={from:f,to:a});continue}n!=="id"&&e[n]!==c[n]&&(l[n]={from:e[n],to:c[n]})}return Object.keys(l).length?t:null},ce=(e,c)=>{const t={name:e.playlist.name,id:e.playlist.id,added:[],removed:[],modified:[]};if(e.playlist.type!==c.playlist.type)return null;if(e.playlist.type==="smart"){const l=e.playlist,i=c.playlist;return JSON.stringify(l.definition)!==JSON.stringify(i.definition)?t:null}if(c.playlist.type!=="smart"){for(const l of e.playlist.songs){const i=c.playlist.songs.find(n=>n.source===l.source);if(i){const n=de(l,i);n&&t.modified.push(n)}else t.removed.push(l)}for(const l of c.playlist.songs)e.playlist.songs.find(n=>n.source===l.source)||t.added.push(l);return t.added.length||t.removed.length||t.modified.length?t:null}},re=(e,c)=>{const t={added:[],removed:[],modified:[]};for(const l of e.collection){const i=c.collection.find(n=>n.playlist.name===l.playlist.name);if(i){const n=ce(l,i);n&&t.modified.push(n)}else t.removed.push(l)}for(const l of c.collection)e.collection.find(n=>n.playlist.name===l.playlist.name)||t.added.push(l);return t},ue={class:"overflow-hidden"},fe={class:"title my-0"},pe={key:0,class:"info"},ye={class:"key"},me={class:"value"},ge=M({__name:"SongDiff",props:{song:{type:Object,required:!0},diff:{type:Object,required:!0},isBase:{type:Boolean,required:!1},expanded:{type:Object,required:!1}},emits:["exclude","toggle-expanded"],setup(e,{emit:c}){const t=e,l=F(()=>t.diff.removed.some(a=>a.source===t.song.source)?"removed":t.diff.modified.some(a=>a.source===t.song.source)?"modified":t.isBase?"base":t.diff.added.some(a=>a.source===t.song.source)?"added":"base"),i=()=>{c("toggle-expanded",t.song)},n=["title","artist","album","source","cover","favourite","metadata"],f=a=>{var v,_,b;const g=(_=(v=t.diff.modified.find(C=>C.source===t.song.source))==null?void 0:v.changed)==null?void 0:_[a],x=t.isBase?"from":"to",p=(g==null?void 0:g[x])??t.song[a];return a=="metadata"?(b=p==null?void 0:p.spotify)==null?void 0:b.id:p};return(a,g)=>{var x,p;return!e.isBase&&P(l)=="removed"?h("",!0):(d(),y("div",{key:0,class:N([P(l),"song px-4 py-2"])},[w(z,{src:e.song.cover,class:"rounded-md"},null,8,["src"]),r("div",ue,[r("p",fe,[w(H,{text:e.song.title},null,8,["text"])]),w(K,{artist:e.song.artist,class:"artist text-muted"},null,8,["artist"])]),r("span",{class:"material-symbols-rounded cursor-pointer",onClick:i},k(((x=e.expanded)==null?void 0:x.source)==e.song.source?"expand_less":"expand_more"),1),((p=e.expanded)==null?void 0:p.source)==e.song.source?(d(),y("div",pe,[(d(),y(B,null,I(n,v=>{var _,b;return r("div",{key:v,class:N([{modified:(b=(_=e.diff.modified.find(C=>C.source===e.song.source))==null?void 0:_.changed)==null?void 0:b[v]},"info__table"])},[r("span",ye,k(v),1),r("span",me,k(f(v)),1)],2)}),64))])):h("",!0)],2))}}});const ve=G(ge,[["__scopeId","data-v-1805c709"]]),xe={class:"info"},he={class:"title"},_e={key:0,class:"material-symbols-rounded"},be={key:0,class:"text-muted"},ke={class:"flex flex-row justify-between items-center"},Se={key:0,class:"text-very-muted"},Pe={key:0},we=M({__name:"PlaylistDiff",props:{playlist:{type:Object,required:!0},diff:{type:Object,required:!0},isBase:{type:Boolean,required:!1},expanded:{type:Boolean,required:!1},expandedSong:{type:Object,required:!1}},emits:["exclude","toggle-expanded","toggle-expanded-song"],setup(e,{emit:c}){const t=e,l=F(()=>t.diff.removed.some(a=>a.playlist.name===t.playlist.name)?"removed":t.diff.modified.some(a=>a.name===t.playlist.name)?"modified":t.isBase?"base":t.diff.added.some(a=>a.playlist.name===t.playlist.name)?"added":"base"),i=()=>{c("toggle-expanded",t.playlist)},n=a=>{c("toggle-expanded-song",a)},f=a=>{const g=t.diff.modified.find(x=>x.name===a.name);return g||{name:a.name,added:[],removed:[],modified:[]}};return(a,g)=>(d(),$(D,{class:N([P(l),"playlist p-4 rounded-xl relative"])},{default:q(()=>{var x;return[w(z,{src:e.playlist.cover,class:"rounded-xl self-start"},null,8,["src"]),r("div",xe,[r("div",he,[e.playlist.type!="classic"?(d(),y("span",_e,k(e.playlist.type=="smart"?"neurology":"bolt"),1)):h("",!0),r("h2",null,k(e.playlist.name),1)]),e.playlist.description?(d(),y("p",be,k(e.playlist.description),1)):h("",!0),r("div",ke,[e.playlist.type==="classic"?(d(),y("p",Se,[r("strong",null,k((x=e.playlist.songs)==null?void 0:x.length),1),j(" tracks ")])):h("",!0),r("span",{class:"material-symbols-rounded cursor-pointer",title:"Expand",onClick:i},k(e.expanded?"expand_less":"expand_more"),1)])]),e.expanded?(d(),$(D,{key:0,class:"col-span-2 flex flex-col gap-2 z-10 p-4"},{default:q(()=>[e.playlist.type==="classic"?(d(!0),y(B,{key:0},I(e.playlist.songs,p=>(d(),$(ve,{key:p.source,diff:f(e.playlist),expanded:e.expandedSong,"is-base":e.isBase,song:p,onToggleExpanded:n},null,8,["diff","expanded","is-base","song"]))),128)):h("",!0),r("pre",null,[j("                "),e.playlist.type==="smart"?(d(),y("code",Pe,`
`+k(JSON.stringify(e.playlist.definition,null,4))+`
                `,1)):h("",!0),j(`
            `)])]),_:1})):h("",!0),P(l)!="base"?(d(),y("span",{key:1,class:"material-symbols-rounded exclude",title:"Exclude",onClick:g[0]||(g[0]=p=>a.$emit("exclude",e.playlist))}," block ")):h("",!0)]}),_:1},8,["class"]))}});const T=G(we,[["__scopeId","data-v-cda0dc11"]]),L=e=>(R("data-v-5b4910f3"),e=e(),Y(),e),Ee={class:"pb-4 pr-4 flex flex-col gap-4 h-full"},Be={class:"flex flex-row justify-end"},$e=L(()=>r("div",{class:"grid grid-cols-2 gap-4"},[r("h1",null,"Local"),r("h1",null,"Incoming")],-1)),Ce={key:1,class:"fill-page"},Oe={key:1,class:"fill-page !grid !grid-cols-2 gap-4"},je=L(()=>r("h2",null,[r("span",{class:"material-symbols-rounded"},"file_upload"),j(" From File ")],-1)),Ie=L(()=>r("h2",null,[r("span",{class:"material-symbols-rounded"},"cloud_download"),j(" GitHub Gist ")],-1)),qe=M({__name:"Import",setup(e){const c=S(!1),t=S(null),l=S({}),i=S({}),n=F(()=>re(l.value,i.value)),f=U();let a=!1;const g=async()=>{var m;if(c.value||a)return;a=!0;const o=[];for(const s of(m=f.playlists)==null?void 0:m.filter(u=>u.type!="special")){const u=Object.assign({},s);o.push(u)}l.value=await ie(o),a=!1};X(()=>f.playlists,g),Q(g);const x=o=>{l.value.collection=l.value.collection.filter(m=>m.playlist.name!==o.name),i.value.collection=i.value.collection.filter(m=>m.playlist.name!==o.name)},p=S(null),v=S(null),_=o=>{var m;((m=p.value)==null?void 0:m.name)===o.name?p.value=null:p.value=o},b=o=>{var m;((m=v.value)==null?void 0:m.id)===o.id?v.value=null:v.value=o},C=async()=>{c.value=!0;const o=[],m=s=>{o.push(ae(s.id,s.added));for(const u of s.removed)o.push(le(s.id,u.id));for(const u of s.modified)for(const E of Object.keys(u.changed))o.push(ne(u.id,E,u.changed[E].to))};for(const s of n.value.added)l.value.collection.push(s),o.push(ee(s.playlist.type,s.playlist.name,s.playlist.description,s.playlist.cover).then(u=>{s.playlist.id=u,s.playlist.type==="classic"?m({id:s.playlist.id,name:s.playlist.name,added:s.playlist.songs,removed:[],modified:[]}):s.playlist.type==="smart"&&o.push(te(s.playlist.id,s.playlist.definition))}));for(const s of n.value.modified)m(s);for(const s of n.value.removed)o.push(se(s.playlist.id));await Promise.all(o),window.setTimeout(async()=>{await f.fetchPlaylists(),c.value=!1,await g()},1e3)},J=S(!1);V.connected().then(o=>J.value=o);const W=async()=>{const o=document.createElement("input");o.type="file",o.accept=".one.*",o.name="my.one.collection",o.onchange=async()=>{if(!o.files)return;const s=await o.files[0].text(),u=JSON.parse(s);i.value=u,t.value="file"},o.click()},A=async()=>{i.value=await V.getContent(),t.value="gist"};return S(null),(o,m)=>(d(),y("div",Ee,[r("div",Be,[w(oe,{icon:"merge",label:"Merge",onClick:C})]),t.value?(d(),y(B,{key:0},[c.value?(d(),y("div",Ce,[w(Z)])):(d(),y(B,{key:0},[$e,(d(!0),y(B,null,I(l.value.collection,s=>{var u,E;return d(),y("div",{key:s.playlist.name,class:"grid grid-cols-2 gap-4"},[l.value.collection.some(O=>O.playlist.name===s.playlist.name)?(d(),$(T,{key:0,diff:P(n),expanded:((u=p.value)==null?void 0:u.name)===s.playlist.name,"expanded-song":v.value,playlist:s.playlist,class:"grid-1","is-base":"",onExclude:x,onToggleExpanded:_,onToggleExpandedSong:b},null,8,["diff","expanded","expanded-song","playlist"])):h("",!0),i.value.collection.some(O=>O.playlist.name===s.playlist.name)?(d(),$(T,{key:1,diff:P(n),expanded:((E=p.value)==null?void 0:E.name)===s.playlist.name,"expanded-song":v.value,playlist:i.value.collection.find(O=>O.playlist.name===s.playlist.name).playlist,class:"grid-2",onExclude:x,onToggleExpanded:_,onToggleExpandedSong:b},null,8,["diff","expanded","expanded-song","playlist"])):h("",!0)])}),128)),(d(!0),y(B,null,I(P(n).added,s=>{var u;return d(),y("div",{key:s.playlist.name,class:"grid grid-cols-2 gap-4"},[i.value.collection.some(E=>E.playlist.name===s.playlist.name)?(d(),$(T,{key:0,diff:P(n),expanded:((u=p.value)==null?void 0:u.name)===s.playlist.name,"expanded-song":v.value,playlist:s.playlist,class:"grid-2",onExclude:x,onToggleExpanded:_,onToggleExpandedSong:b},null,8,["diff","expanded","expanded-song","playlist"])):h("",!0)])}),128))],64))],64)):(d(),y("div",Oe,[w(D,{"with-hover":"",class:"cursor-pointer",onClick:W},{default:q(()=>[je]),_:1}),w(D,{disabled:!J.value,"with-hover":"",class:"cursor-pointer",onClick:A},{default:q(()=>[Ie]),_:1},8,["disabled"])]))]))}});const Fe=G(qe,[["__scopeId","data-v-5b4910f3"]]);export{Fe as default};
