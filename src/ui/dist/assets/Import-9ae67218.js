import{n as M,A as F,u as k,o as l,c as g,g as S,h as z,a as c,M as J,bS as K,t as P,F as B,i as I,aA as T,d as w,_ as L,f as j,w as q,b as G,C as D,q as b,j as Q,bs as R,aI as U,l as X,m as Y,L as Z,x as ee,bL as se,c0 as ae}from"./index-2d9f3e6e.js";import{G as A}from"./gistClient-42cf4b25.js";import{I as te}from"./IconButton-943d75c7.js";import{a as ne,u as oe}from"./song-2269cc62.js";const de=(e,r)=>{const s={source:e.source,id:e.id,changed:{}},n=s.changed,i=["id","href","duration","plays","artists"];for(const o of Object.keys(e))if(!i.includes(o)){if(o==="metadata"){const f=e.metadata,a=r.metadata;if(f&&a){if(!f.spotify&&!a.spotify)continue;if(!f.spotify&&a.spotify){n.metadata={from:f,to:a};continue}if(f.spotify&&!a.spotify){n.metadata={from:f,to:a};continue}f.spotify.id!==a.spotify.id&&(n.metadata={from:f,to:a})}else(f||a)&&(n.metadata={from:f,to:a});continue}o!=="id"&&e[o]!==r[o]&&(n[o]={from:e[o],to:r[o]})}return Object.keys(n).length?s:null},ie=(e,r)=>{const s={name:e.name,id:e.id,added:[],removed:[],modified:[]};for(const n of e.songs){const i=r.songs.find(o=>o.source===n.source);if(i){const o=de(n,i);o&&s.modified.push(o)}else s.removed.push(n)}for(const n of r.songs)e.songs.find(o=>o.source===n.source)||s.added.push(n);return s.added.length||s.removed.length||s.modified.length?s:null},le=(e,r)=>{const s={added:[],removed:[],modified:[]};for(const n of e){const i=r.find(o=>o.name===n.name);if(i){const o=ie(n,i);o&&s.modified.push(o)}else s.removed.push(n)}for(const n of r)e.find(o=>o.name===n.name)||s.added.push(n);return s},ce={class:"overflow-hidden"},re={class:"title my-0"},ue={key:0,class:"info"},fe={class:"key"},me={class:"value"},ge=M({__name:"SongDiff",props:{song:{type:Object,required:!0},diff:{type:Object,required:!0},isBase:{type:Boolean,required:!1},expanded:{type:Object,required:!1}},emits:["exclude","toggle-expanded"],setup(e,{emit:r}){const s=e,n=F(()=>s.diff.removed.some(a=>a.source===s.song.source)?"removed":s.diff.modified.some(a=>a.source===s.song.source)?"modified":s.isBase?"base":s.diff.added.some(a=>a.source===s.song.source)?"added":"base"),i=()=>{r("toggle-expanded",s.song)},o=["title","artist","album","source","cover","favourite","metadata"],f=a=>{var x,h,_;const p=(h=(x=s.diff.modified.find($=>$.source===s.song.source))==null?void 0:x.changed)==null?void 0:h[a],y=s.isBase?"from":"to",v=(p==null?void 0:p[y])??s.song[a];return a=="metadata"?(_=v==null?void 0:v.spotify)==null?void 0:_.id:v};return(a,p)=>{var y,v;return!e.isBase&&k(n)=="removed"?w("",!0):(l(),g("div",{key:0,class:T([k(n),"song px-4 py-2"])},[S(z,{src:e.song.cover,class:"rounded-md"},null,8,["src"]),c("div",ce,[c("p",re,[S(J,{text:e.song.title},null,8,["text"])]),S(K,{artist:e.song.artist,class:"artist text-muted"},null,8,["artist"])]),c("span",{class:"material-symbols-rounded cursor-pointer",onClick:i},P(((y=e.expanded)==null?void 0:y.source)==e.song.source?"expand_less":"expand_more"),1),((v=e.expanded)==null?void 0:v.source)==e.song.source?(l(),g("div",ue,[(l(),g(B,null,I(o,x=>{var h,_;return c("div",{key:x,class:T([{modified:(_=(h=e.diff.modified.find($=>$.source===e.song.source))==null?void 0:h.changed)==null?void 0:_[x]},"info__table"])},[c("span",fe,P(x),1),c("span",me,P(f(x)),1)],2)}),64))])):w("",!0)],2))}}});const pe=L(ge,[["__scopeId","data-v-1805c709"]]),ye={class:"info"},ve={class:"my-0"},xe={key:0,class:"text-muted"},he={class:"flex flex-row justify-between items-center"},_e={class:"text-very-muted"},be=M({__name:"PlaylistDiff",props:{playlist:{type:Object,required:!0},diff:{type:Object,required:!0},isBase:{type:Boolean,required:!1},expanded:{type:Boolean,required:!1},expandedSong:{type:Object,required:!1}},emits:["exclude","toggle-expanded","toggle-expanded-song"],setup(e,{emit:r}){const s=e,n=F(()=>s.diff.removed.some(a=>a.name===s.playlist.name)?"removed":s.diff.modified.some(a=>a.name===s.playlist.name)?"modified":s.isBase?"base":s.diff.added.some(a=>a.name===s.playlist.name)?"added":"base"),i=()=>{r("toggle-expanded",s.playlist)},o=a=>{r("toggle-expanded-song",a)},f=a=>{const p=s.diff.modified.find(y=>y.name===a.name);return p||{name:a.name,added:[],removed:[],modified:[]}};return(a,p)=>(l(),j(D,{class:T([k(n),"playlist p-4 rounded-xl relative"])},{default:q(()=>[S(z,{src:e.playlist.cover,class:"rounded-xl self-start"},null,8,["src"]),c("div",ye,[c("h2",ve,P(e.playlist.name),1),e.playlist.description?(l(),g("p",xe,P(e.playlist.description),1)):w("",!0),c("div",he,[c("p",_e,[c("strong",null,P(e.playlist.songs.length),1),G(" tracks ")]),c("span",{class:"material-symbols-rounded cursor-pointer",title:"Expand",onClick:i},P(e.expanded?"expand_less":"expand_more"),1)])]),e.expanded?(l(),j(D,{key:0,class:"col-span-2 flex flex-col gap-2 z-10 p-4"},{default:q(()=>[(l(!0),g(B,null,I(e.playlist.songs,y=>(l(),j(pe,{key:y.source,diff:f(e.playlist),expanded:e.expandedSong,"is-base":e.isBase,song:y,onToggleExpanded:o},null,8,["diff","expanded","is-base","song"]))),128))]),_:1})):w("",!0),k(n)!="base"?(l(),g("span",{key:1,class:"material-symbols-rounded exclude",title:"Exclude",onClick:p[0]||(p[0]=y=>a.$emit("exclude",e.playlist))}," block ")):w("",!0)]),_:1},8,["class"]))}});const O=L(be,[["__scopeId","data-v-321aa4c3"]]),N=e=>(X("data-v-8ce823ef"),e=e(),Y(),e),ke={class:"pb-4 pr-4 flex flex-col gap-4 h-full"},Se={class:"flex flex-row justify-end"},we=N(()=>c("div",{class:"grid grid-cols-2 gap-4"},[c("h1",null,"Local"),c("h1",null,"Incoming")],-1)),Ee={key:1,class:"fill-page"},Pe={key:1,class:"fill-page !grid !grid-cols-2 gap-4"},Be=N(()=>c("h2",null,[c("span",{class:"material-symbols-rounded"},"file_upload"),G(" From File ")],-1)),je=N(()=>c("h2",null,[c("span",{class:"material-symbols-rounded"},"cloud_download"),G(" GitHub Gist ")],-1)),$e=M({__name:"Import",setup(e){const r=b(!1),s=b(null),n=b([]),i=b([]),o=F(()=>le(n.value,i.value)),f=Q();let a=!1;const p=async()=>{if(r.value||a)return;a=!0;const d=[];for(const m of f.playlists)try{const u=await(await fetch(`/api/playlists/${m.id}`)).json();d.push(u)}catch(t){console.error(t)}n.value=d,a=!1};R(()=>f.playlists,p),U(p);const y=d=>{n.value=n.value.filter(m=>m.name!==d.name),i.value=i.value.filter(m=>m.name!==d.name)},v=b(null),x=b(null),h=d=>{var m;((m=v.value)==null?void 0:m.name)===d.name?v.value=null:v.value=d},_=d=>{var m;((m=x.value)==null?void 0:m.id)===d.id?x.value=null:x.value=d},$=async()=>{r.value=!0;const d=[],m=t=>{for(const u of t.added)d.push(ne(t.id,u));for(const u of t.removed)d.push(ae(t.id,u.id));for(const u of t.modified)for(const E of Object.keys(u.changed))d.push(oe(u.id,E,u.changed[E].to))};for(const t of o.value.added)n.value.push(t),d.push(ee(t.name,t.description,t.cover).then(u=>{t.id=u,m({id:t.id,name:t.name,added:t.songs,removed:[],modified:[]})}));for(const t of o.value.modified)m(t);for(const t of o.value.removed)d.push(se(t.id));await Promise.all(d),window.setTimeout(async()=>{await f.fetchPlaylists(),r.value=!1,await p()},1e3)},V=b(!1);A.connected().then(d=>V.value=d);const W=async()=>{const d=document.createElement("input");d.type="file",d.accept=".json",d.name="lib.one.json",d.onchange=async()=>{if(!d.files)return;const t=await d.files[0].text(),u=JSON.parse(t);i.value=u,s.value="file"},d.click()},H=async()=>{i.value=await A.getContent(),s.value="gist"};return b(null),(d,m)=>(l(),g("div",ke,[c("div",Se,[S(te,{icon:"merge",label:"Merge",onClick:$})]),s.value?(l(),g(B,{key:0},[r.value?(l(),g("div",Ee,[S(Z)])):(l(),g(B,{key:0},[we,(l(!0),g(B,null,I(n.value,t=>{var u,E;return l(),g("div",{key:t.name,class:"grid grid-cols-2 gap-4"},[n.value.some(C=>C.name===t.name)?(l(),j(O,{key:0,diff:k(o),expanded:((u=v.value)==null?void 0:u.name)===t.name,"expanded-song":x.value,playlist:t,class:"grid-1","is-base":"",onExclude:y,onToggleExpanded:h,onToggleExpandedSong:_},null,8,["diff","expanded","expanded-song","playlist"])):w("",!0),i.value.some(C=>C.name===t.name)?(l(),j(O,{key:1,diff:k(o),expanded:((E=v.value)==null?void 0:E.name)===t.name,"expanded-song":x.value,playlist:i.value.find(C=>C.name===t.name),class:"grid-2",onExclude:y,onToggleExpanded:h,onToggleExpandedSong:_},null,8,["diff","expanded","expanded-song","playlist"])):w("",!0)])}),128)),(l(!0),g(B,null,I(k(o).added,t=>{var u;return l(),g("div",{key:t.name,class:"grid grid-cols-2 gap-4"},[i.value.some(E=>E.name===t.name)?(l(),j(O,{key:0,diff:k(o),expanded:((u=v.value)==null?void 0:u.name)===t.name,"expanded-song":x.value,playlist:t,class:"grid-2",onExclude:y,onToggleExpanded:h,onToggleExpandedSong:_},null,8,["diff","expanded","expanded-song","playlist"])):w("",!0)])}),128))],64))],64)):(l(),g("div",Pe,[S(D,{"with-hover":"",class:"cursor-pointer",onClick:W},{default:q(()=>[Be]),_:1}),S(D,{disabled:!V.value,"with-hover":"",class:"cursor-pointer",onClick:H},{default:q(()=>[je]),_:1},8,["disabled"])]))]))}});const Oe=L($e,[["__scopeId","data-v-8ce823ef"]]);export{Oe as default};
