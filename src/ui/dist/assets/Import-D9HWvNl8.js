import{e as M,D as N,o as d,c as m,g as E,H as V,a as r,M as K,K as W,t as S,F as $,h as D,Q as F,d as h,_ as G,i as B,w as q,b as j,C as I,n as _,j as A,E as Q,y as R,I as U,L as X,aC as Y,x as Z,a0 as ee,a1 as te,l as se,m as ae,aD as le,aE as ne,aF as ie}from"./index-CFO58RnV.js";import{G as J}from"./gistClient-D2eon_Qy.js";const oe=(e,c)=>{const t={source:e.source,id:e.id,changed:{}},a=t.changed,o=["id","href","duration","plays","artists"];for(const l of Object.keys(e))if(!o.includes(l)){if(l==="metadata"){const f=e.metadata,p=c.metadata;if(f&&p){if(!f.spotify&&!p.spotify)continue;if(!f.spotify&&p.spotify){a.metadata={from:f,to:p};continue}if(f.spotify&&!p.spotify){a.metadata={from:f,to:p};continue}f.spotify.id!==p.spotify.id&&(a.metadata={from:f,to:p})}else(f||p)&&(a.metadata={from:f,to:p});continue}l!=="id"&&e[l]!==c[l]&&(a[l]={from:e[l],to:c[l]})}return Object.keys(a).length?t:null},de=(e,c)=>{const t={name:e.playlist.name,id:e.playlist.id,added:[],removed:[],modified:[]};if(e.playlist.type!==c.playlist.type)return null;if(e.playlist.type==="smart"){const a=e.playlist,o=c.playlist;return JSON.stringify(a.definition)!==JSON.stringify(o.definition)?t:null}if(c.playlist.type!=="smart"){for(const a of e.playlist.songs){const o=c.playlist.songs.find(l=>l.source===a.source);if(o){const l=oe(a,o);l&&t.modified.push(l)}else t.removed.push(a)}for(const a of c.playlist.songs)e.playlist.songs.find(l=>l.source===a.source)||t.added.push(a);return t.added.length||t.removed.length||t.modified.length?t:null}},ce=(e,c)=>{const t={added:[],removed:[],modified:[]};for(const a of e.collection){const o=c.collection.find(l=>l.playlist.name===a.playlist.name);if(o){const l=de(a,o);l&&t.modified.push(l)}else t.removed.push(a)}for(const a of c.collection)e.collection.find(l=>l.playlist.name===a.playlist.name)||t.added.push(a);return t},re={class:"overflow-hidden"},ue={class:"title my-0"},fe={key:0,class:"info"},pe={class:"key"},ye={class:"value"},me=M({__name:"SongDiff",props:{song:{type:Object,required:!0},diff:{type:Object,required:!0},isBase:{type:Boolean,required:!1},expanded:{type:Object,required:!1}},emits:["exclude","toggle-expanded"],setup(e,{emit:c}){const t=e,a=N(()=>t.diff.removed.some(i=>i.source===t.song.source)?"removed":t.diff.modified.some(i=>i.source===t.song.source)?"modified":t.isBase?"base":t.diff.added.some(i=>i.source===t.song.source)?"added":"base"),o=c,l=()=>{o("toggle-expanded",t.song)},f=["title","artist","album","source","cover","favourite","metadata"],p=i=>{var b,k,P;const x=(k=(b=t.diff.modified.find(C=>C.source===t.song.source))==null?void 0:b.changed)==null?void 0:k[i],v=t.isBase?"from":"to",y=(x==null?void 0:x[v])??t.song[i];return i=="metadata"?(P=y==null?void 0:y.spotify)==null?void 0:P.id:y};return(i,x)=>{var v,y;return!e.isBase&&a.value=="removed"?h("",!0):(d(),m("div",{key:0,class:F([a.value,"song px-4 py-2"])},[E(V,{src:e.song.cover,class:"rounded-md"},null,8,["src"]),r("div",re,[r("p",ue,[E(K,{text:e.song.title},null,8,["text"])]),E(W,{artist:e.song.artist,class:"artist text-muted"},null,8,["artist"])]),r("span",{class:"material-symbols-rounded cursor-pointer",onClick:l},S(((v=e.expanded)==null?void 0:v.source)==e.song.source?"expand_less":"expand_more"),1),((y=e.expanded)==null?void 0:y.source)==e.song.source?(d(),m("div",fe,[(d(),m($,null,D(f,b=>{var k,P;return r("div",{key:b,class:F([{modified:(P=(k=e.diff.modified.find(C=>C.source===e.song.source))==null?void 0:k.changed)==null?void 0:P[b]},"info__table"])},[r("span",pe,S(b),1),r("span",ye,S(p(b)),1)],2)}),64))])):h("",!0)],2))}}}),ge=G(me,[["__scopeId","data-v-1805c709"]]),ve={class:"info"},xe={class:"title"},he={key:0,class:"material-symbols-rounded"},be={key:0,class:"text-muted"},ke={class:"flex flex-row justify-between items-center"},Se={key:0,class:"text-very-muted"},_e={key:0},Ee=M({__name:"PlaylistDiff",props:{playlist:{type:Object,required:!0},diff:{type:Object,required:!0},isBase:{type:Boolean,required:!1},expanded:{type:Boolean,required:!1},expandedSong:{type:Object,required:!1}},emits:["exclude","toggle-expanded","toggle-expanded-song"],setup(e,{emit:c}){const t=e,a=N(()=>t.diff.removed.some(i=>i.playlist.name===t.playlist.name)?"removed":t.diff.modified.some(i=>i.name===t.playlist.name)?"modified":t.isBase?"base":t.diff.added.some(i=>i.playlist.name===t.playlist.name)?"added":"base"),o=c,l=()=>{o("toggle-expanded",t.playlist)},f=i=>{o("toggle-expanded-song",i)},p=i=>{const x=t.diff.modified.find(v=>v.name===i.name);return x||{name:i.name,added:[],removed:[],modified:[]}};return(i,x)=>(d(),B(I,{class:F([a.value,"playlist p-4 rounded-xl relative"])},{default:q(()=>{var v;return[E(V,{src:e.playlist.cover,class:"rounded-xl self-start"},null,8,["src"]),r("div",ve,[r("div",xe,[e.playlist.type!="classic"?(d(),m("span",he,S(e.playlist.type=="smart"?"neurology":"bolt"),1)):h("",!0),r("h2",null,S(e.playlist.name),1)]),e.playlist.description?(d(),m("p",be,S(e.playlist.description),1)):h("",!0),r("div",ke,[e.playlist.type==="classic"?(d(),m("p",Se,[r("strong",null,S((v=e.playlist.songs)==null?void 0:v.length),1),j(" tracks ")])):h("",!0),r("span",{class:"material-symbols-rounded cursor-pointer",title:"Expand",onClick:l},S(e.expanded?"expand_less":"expand_more"),1)])]),e.expanded?(d(),B(I,{key:0,class:"col-span-2 flex flex-col gap-2 z-10 p-4"},{default:q(()=>[e.playlist.type==="classic"?(d(!0),m($,{key:0},D(e.playlist.songs,y=>(d(),B(ge,{key:y.source,diff:p(e.playlist),expanded:e.expandedSong,"is-base":e.isBase,song:y,onToggleExpanded:f},null,8,["diff","expanded","is-base","song"]))),128)):h("",!0),r("pre",null,[j("                "),e.playlist.type==="smart"?(d(),m("code",_e,`
`+S(JSON.stringify(e.playlist.definition,null,4))+`
                `,1)):h("",!0),j(`
            `)])]),_:1})):h("",!0),a.value!="base"?(d(),m("span",{key:1,class:"material-symbols-rounded exclude",title:"Exclude",onClick:x[0]||(x[0]=y=>i.$emit("exclude",e.playlist))}," block ")):h("",!0)]}),_:1},8,["class"]))}}),T=G(Ee,[["__scopeId","data-v-51b40518"]]),L=e=>(se("data-v-3e5b815e"),e=e(),ae(),e),Pe={class:"pb-4 pr-4 flex flex-col gap-4 h-full"},we={class:"flex flex-row justify-end"},Ce=L(()=>r("div",{class:"grid grid-cols-2 gap-4"},[r("h1",null,"Local"),r("h1",null,"Incoming")],-1)),$e={key:1,class:"fill-page"},Be={key:1,class:"fill-page !grid !grid-cols-2 gap-4"},Oe=L(()=>r("h2",null,[r("span",{class:"material-symbols-rounded"},"file_upload"),j(" From File ")],-1)),je=L(()=>r("h2",null,[r("span",{class:"material-symbols-rounded"},"cloud_download"),j(" GitHub Gist ")],-1)),De=M({__name:"Import",setup(e){const c=_(!1),t=_(null),a=_({}),o=_({}),l=N(()=>ce(a.value,o.value)),f=A();let p=!1;const i=async()=>{var g;if(c.value||p)return;p=!0;const n=[];for(const s of(g=f.playlists)==null?void 0:g.filter(u=>u.type!="special")){const u=Object.assign({},s);n.push(u)}a.value=await Y(n),p=!1};Q(()=>f.playlists,i),R(i);const x=n=>{a.value.collection=a.value.collection.filter(g=>g.playlist.name!==n.name),o.value.collection=o.value.collection.filter(g=>g.playlist.name!==n.name)},v=_(null),y=_(null),b=n=>{var g;((g=v.value)==null?void 0:g.name)===n.name?v.value=null:v.value=n},k=n=>{var g;((g=y.value)==null?void 0:g.id)===n.id?y.value=null:y.value=n},P=async()=>{c.value=!0;const n=[],g=s=>{n.push(le(s.id,s.added));for(const u of s.removed)n.push(ne(s.id,u.id));for(const u of s.modified)for(const w of Object.keys(u.changed))n.push(ie(u.id,w,u.changed[w].to))};for(const s of l.value.added)s.playlist.type!=="special"&&(a.value.collection.push(s),n.push(Z(s.playlist.type,s.playlist.name,s.playlist.description,s.playlist.cover).then(u=>{s.playlist.id=u,s.playlist.type==="classic"?g({id:s.playlist.id,name:s.playlist.name,added:s.playlist.songs,removed:[],modified:[]}):s.playlist.type==="smart"&&n.push(ee(s.playlist.id,s.playlist.definition))})));for(const s of l.value.modified)g(s);for(const s of l.value.removed)n.push(te(s.playlist.id));await Promise.all(n),window.setTimeout(async()=>{await f.fetchPlaylists(),c.value=!1,await i()},1e3)},C=_(!1);J.connected().then(n=>C.value=n);const z=async()=>{const n=document.createElement("input");n.type="file",n.accept=".one.*",n.name="my.one.collection",n.onchange=async()=>{if(!n.files)return;const s=await n.files[0].text(),u=JSON.parse(s);o.value=u,t.value="file"},n.click()},H=async()=>{o.value=await J.getContent(),t.value="gist"};return _(null),(n,g)=>(d(),m("div",Pe,[r("div",we,[E(U,{icon:"merge",label:"Merge",onClick:P})]),t.value?(d(),m($,{key:0},[c.value?(d(),m("div",$e,[E(X)])):(d(),m($,{key:0},[Ce,(d(!0),m($,null,D(a.value.collection,s=>{var u,w;return d(),m("div",{key:s.playlist.name,class:"grid grid-cols-2 gap-4"},[a.value.collection.some(O=>O.playlist.name===s.playlist.name)?(d(),B(T,{key:0,diff:l.value,expanded:((u=v.value)==null?void 0:u.name)===s.playlist.name,"expanded-song":y.value,playlist:s.playlist,class:"grid-1","is-base":"",onExclude:x,onToggleExpanded:b,onToggleExpandedSong:k},null,8,["diff","expanded","expanded-song","playlist"])):h("",!0),o.value.collection.some(O=>O.playlist.name===s.playlist.name)?(d(),B(T,{key:1,diff:l.value,expanded:((w=v.value)==null?void 0:w.name)===s.playlist.name,"expanded-song":y.value,playlist:o.value.collection.find(O=>O.playlist.name===s.playlist.name).playlist,class:"grid-2",onExclude:x,onToggleExpanded:b,onToggleExpandedSong:k},null,8,["diff","expanded","expanded-song","playlist"])):h("",!0)])}),128)),(d(!0),m($,null,D(l.value.added,s=>{var u;return d(),m("div",{key:s.playlist.name,class:"grid grid-cols-2 gap-4"},[o.value.collection.some(w=>w.playlist.name===s.playlist.name)?(d(),B(T,{key:0,diff:l.value,expanded:((u=v.value)==null?void 0:u.name)===s.playlist.name,"expanded-song":y.value,playlist:s.playlist,class:"grid-2",onExclude:x,onToggleExpanded:b,onToggleExpandedSong:k},null,8,["diff","expanded","expanded-song","playlist"])):h("",!0)])}),128))],64))],64)):(d(),m("div",Be,[E(I,{"with-hover":"",class:"cursor-pointer",onClick:z},{default:q(()=>[Oe]),_:1}),E(I,{disabled:!C.value,"with-hover":"",class:"cursor-pointer",onClick:H},{default:q(()=>[je]),_:1},8,["disabled"])]))]))}}),Te=G(De,[["__scopeId","data-v-3e5b815e"]]);export{Te as default};
